<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generala Amiga - Versi√≥n Hist√≥rica</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --primary: #f1c40f; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --success: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        
        .setup, .juego, .historial { background: var(--card); padding: 25px; border-radius: 20px; width: 95%; max-width: 800px; text-align: center; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; }
        .oculto { display: none; }

        /* DADOS */
        .dados-container { display: flex; justify-content: center; gap: 15px; margin: 20px 0; height: 90px; align-items: center; flex-wrap: wrap; }
        .dado-visual {
            width: 65px; height: 65px; background: white; border-radius: 12px;
            display: grid; grid-template: repeat(3, 1fr) / repeat(3, 1fr);
            padding: 8px; box-sizing: border-box; cursor: pointer;
            transition: all 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28); border: 4px solid transparent;
        }
        .dot { background: #333; border-radius: 50%; width: 10px; height: 10px; margin: auto; }
        .bloqueado { background: var(--primary) !important; transform: translateY(-12px); box-shadow: 0 8px 15px rgba(241, 196, 15, 0.4); }
        .girando { animation: saltar 0.15s infinite alternate; }
        @keyframes saltar { 0% { transform: translateY(0) rotate(0deg); } 100% { transform: translateY(-15px) rotate(10deg); } }

        /* TABLA */
        .contenedor-tabla { overflow-x: auto; width: 100%; margin-top: 20px; border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; background: #252525; }
        th, td { border: 1px solid #333; padding: 10px; text-align: center; }
        th { background: #333; color: var(--primary); }
        .celda-activa { background: rgba(39, 174, 96, 0.2); cursor: pointer; color: #2ecc71; font-weight: bold; }
        .celda-tachar { color: #e74c3c; font-style: italic; opacity: 0.6; }
        .anotado { color: var(--primary); font-weight: bold; }
        .fila-total { background: #1a1a1a; font-weight: bold; color: #fff; }

        /* HISTORIAL */
        .item-historial { background: #252525; padding: 10px; border-radius: 10px; margin: 10px 0; text-align: left; border-left: 4px solid var(--primary); }
        .fecha-historial { font-size: 0.8rem; color: #888; margin-bottom: 5px; }

        #cartel-ganador { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--primary); color: #000; padding: 40px; border-radius: 30px; z-index: 1000; text-align: center; border: 4px solid white; }
        button { background: var(--success); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; margin: 5px; }
        input { padding: 12px; border-radius: 8px; border: 1px solid #444; background: #252525; color: white; }
    </style>
</head>
<body>

    <div id="seccion-registro" class="setup">
        <h2>üé≤ Nueva Partida</h2>
        <p id="fecha-actual" style="color: var(--primary); font-weight: bold;"></p>
        <input type="text" id="nombre-input" placeholder="Nombre del jugador...">
        <button onclick="agregarJugador()">A√±adir</button>
        <div id="lista-nombres" style="margin: 15px 0;"></div>
        <button id="btn-iniciar" class="oculto" onclick="iniciarJuego()">¬°EMPEZAR!</button>
    </div>

    <div id="seccion-juego" class="juego oculto">
        <h2 id="turno-de" style="color: var(--primary);">Turno de: -</h2>
        <div class="dados-container" id="contenedor-dados"></div>
        <button id="btn-lanzar" onclick="lanzar()">LANZAR (Tiros: 3)</button>
        <p id="instruccion">Tira los dados</p>
        <div class="contenedor-tabla">
            <table>
                <thead><tr id="header-jugadores"><th>Categor√≠a</th></tr></thead>
                <tbody id="cuerpo-tabla"></tbody>
                <tfoot><tr id="footer-totales" class="fila-total"><td>TOTAL</td></tr></tfoot>
            </table>
        </div>
    </div>

    <div class="historial">
        <h3>üìú Historial de Campeones</h3>
        <div id="lista-historial">
            <p style="color:#666">No hay partidas registradas a√∫n.</p>
        </div>
        <button onclick="borrarHistorial()" style="background:#c0392b; font-size:0.7rem; margin-top:10px">Borrar Historial</button>
    </div>

    <div id="cartel-ganador" class="oculto">
        <h1 style="font-size: 3rem; margin: 0;">üèÜ</h1>
        <h2 id="nombre-ganador"></h2>
        <p id="puntos-ganador" style="font-size: 1.2rem;"></p>
        <button onclick="location.reload()" style="background: black;">Nueva Partida</button>
    </div>

<script>
    let jugadores = [], indiceTurno = 0, tiros = 3, dadosValores = [0,0,0,0,0], bloqueados = [false, false, false, false, false];
    let celdasOcupadas = 0;
    const categorias = ["1", "2", "3", "4", "5", "6", "Escalera", "Full", "Poker", "Generala", "Doble Gen"];
    const layouts = { 1: [4], 2: [0, 8], 3: [0, 4, 8], 4: [0, 2, 6, 8], 5: [0, 2, 4, 6, 8], 6: [0, 3, 6, 2, 5, 8] };

    // Mostrar fecha al inicio
    const opcionesFecha = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('fecha-actual').innerText = new Date().toLocaleDateString('es-ES', opcionesFecha);

    // Cargar historial al abrir
    window.onload = mostrarHistorial;

    function dibujarDados() {
        const contenedor = document.getElementById('contenedor-dados');
        contenedor.innerHTML = '';
        for(let i=0; i<5; i++) {
            const div = document.createElement('div');
            div.className = `dado-visual ${bloqueados[i] ? 'bloqueado' : ''}`;
            div.onclick = () => toggleDado(i);
            if (dadosValores[i] > 0) {
                for(let j=0; j<9; j++) {
                    const punto = document.createElement('div');
                    if (layouts[dadosValores[i]].includes(j)) punto.className = 'dot';
                    div.appendChild(punto);
                }
            }
            contenedor.appendChild(div);
        }
    }

    function agregarJugador() {
        const input = document.getElementById('nombre-input');
        if (input.value.trim()) {
            jugadores.push({ nombre: input.value.trim(), total: 0 });
            renderLista();
            input.value = "";
        }
    }

    function renderLista() {
        const lista = document.getElementById('lista-nombres');
        lista.innerHTML = jugadores.map((j, i) => `<span class="jugador-tag">${j.nombre}</span>`).join('');
        document.getElementById('btn-iniciar').classList.toggle('oculto', jugadores.length === 0);
    }

    function iniciarJuego() {
        document.getElementById('seccion-registro').classList.add('oculto');
        document.getElementById('seccion-juego').classList.remove('oculto');
        jugadores.forEach((j, idx) => {
            document.getElementById('header-jugadores').innerHTML += `<th>${j.nombre}</th>`;
            document.getElementById('footer-totales').innerHTML += `<td id="total-${idx}">0</td>`;
        });
        categorias.forEach(cat => {
            document.getElementById('cuerpo-tabla').innerHTML += `<tr><td style="font-weight:bold">${cat}</td>` + 
                jugadores.map((_, i) => `<td id="p-${cat}-${i}" class="celda-puntos">-</td>`).join('') + `</tr>`;
        });
        dibujarDados(); actualizarTurno();
    }

    function lanzar() {
        if (tiros > 0) {
            tiros--;
            document.getElementById('btn-lanzar').innerText = `LANZAR (${tiros})`;
            const dadosElems = document.querySelectorAll('.dado-visual');
            dadosElems.forEach((d, i) => { if(!bloqueados[i]) d.classList.add('girando'); });
            setTimeout(() => {
                dadosElems.forEach((d, i) => {
                    if(!bloqueados[i]) dadosValores[i] = Math.floor(Math.random() * 6) + 1;
                    d.classList.remove('girando');
                });
                dibujarDados();
                calcularOpciones(tiros === 2);
            }, 600);
        }
    }

    function calcularOpciones(esServida) {
        limpiarOtras();
        const conteo = {1:0, 2:0, 3:0, 4:0, 5:0, 6:0}; 
        dadosValores.forEach(v => { if(v > 0) conteo[v]++; });
        const vals = Object.values(conteo);
        const unicosStr = [...new Set(dadosValores.filter(v => v > 0))].sort((a,b)=>a-b).join('');
        const bono = esServida ? 5 : 0;
        const yaTieneGenerala = (document.getElementById(`p-Generala-${indiceTurno}`).getAttribute('data-fixed') === 'true');

        categorias.forEach(cat => {
            let pts = 0;
            if (!isNaN(cat)) pts = conteo[parseInt(cat)] * parseInt(cat);
            else if (cat === "Escalera" && (unicosStr === "12345" || unicosStr === "23456" || unicosStr === "13456")) pts = 20 + bono;
            else if (cat === "Full" && vals.includes(3) && vals.includes(2)) pts = 30 + bono;
            else if (cat === "Poker" && (vals.includes(4) || vals.includes(5))) pts = 40 + bono;
            else if (cat === "Generala" && vals.includes(5) && !yaTieneGenerala) pts = 50;
            else if (cat === "Doble Gen" && vals.includes(5) && yaTieneGenerala) pts = 100;

            const celda = document.getElementById(`p-${cat}-${indiceTurno}`);
            if (celda && celda.getAttribute('data-fixed') !== 'true') {
                celda.innerText = pts === 0 ? "Tachar" : pts;
                celda.classList.add('celda-activa');
                if (pts === 0) celda.classList.add('celda-tachar');
                celda.onclick = () => {
                    celda.innerText = pts; celda.className = 'anotado'; celda.setAttribute('data-fixed', 'true');
                    jugadores[indiceTurno].total += pts;
                    document.getElementById(`total-${indiceTurno}`).innerText = jugadores[indiceTurno].total;
                    celdasOcupadas++;
                    if (celdasOcupadas === jugadores.length * categorias.length) finalizarJuego();
                    else { limpiarOtras(); indiceTurno = (indiceTurno + 1) % jugadores.length; actualizarTurno(); }
                };
            }
        });
    }

    function finalizarJuego() {
        const podio = [...jugadores].sort((a, b) => b.total - a.total);
        const ganador = podio[0];
        
        // Guardar en Historial
        const partida = {
            fecha: new Date().toLocaleString(),
            podio: podio.map(p => `${p.nombre}: ${p.total} pts`)
        };
        let historial = JSON.parse(localStorage.getItem('generala_historial')) || [];
        historial.unshift(partida);
        localStorage.setItem('generala_historial', JSON.stringify(historial.slice(0, 10))); // Guardar √∫ltimos 10

        confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
        document.getElementById('nombre-ganador').innerText = `¬°CAMPE√ìN: ${ganador.nombre.toUpperCase()}!`;
        document.getElementById('puntos-ganador').innerText = `Puntaje Final: ${ganador.total}`;
        document.getElementById('cartel-ganador').classList.remove('oculto');
        mostrarHistorial();
    }

    function mostrarHistorial() {
        const lista = document.getElementById('lista-historial');
        const datos = JSON.parse(localStorage.getItem('generala_historial')) || [];
        if (datos.length === 0) return;
        lista.innerHTML = datos.map(p => `
            <div class="item-historial">
                <div class="fecha-historial">üìÖ ${p.fecha}</div>
                <strong>üèÜ ${p.podio[0]}</strong><br>
                <small>${p.podio.slice(1).join(' | ')}</small>
            </div>
        `).join('');
    }

    function borrarHistorial() { if(confirm("¬øBorrar todos los r√©cords?")) { localStorage.removeItem('generala_historial'); location.reload(); } }
    function limpiarOtras() { document.querySelectorAll('.celda-activa').forEach(c => { c.innerText = "-"; c.classList.remove('celda-activa', 'celda-tachar'); c.onclick = null; }); }
    function actualizarTurno() {
        document.getElementById('turno-de').innerText = "Turno de: " + jugadores[indiceTurno].nombre;
        tiros = 3; bloqueados = [false, false, false, false, false]; dadosValores = [0,0,0,0,0];
        document.getElementById('btn-lanzar').innerText = `LANZAR (${tiros})`;
        dibujarDados(); document.getElementById('instruccion').innerText = "Tira los dados";
    }
    function toggleDado(i) { if (tiros < 3 && tiros > 0 && dadosValores[0] !== 0) { bloqueados[i] = !bloqueados[i]; dibujarDados(); } }
    dibujarDados();
</script>
</body>
</html>

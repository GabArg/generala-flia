<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3655/3655610.png?v=3">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3655/3655610.png?v=3">
    <meta property="og:image" content="https://cdn-icons-png.flaticon.com/512/3655/3655610.png?v=3">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Generala Amiga - Versi√≥n Blindada</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --primary: #f1c40f; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --success: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
        .setup, .juego, .historial { background: var(--card); padding: 15px; border-radius: 20px; width: 95%; max-width: 800px; text-align: center; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 15px; box-sizing: border-box; }
        .oculto { display: none; }
        #lista-nombres { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 20px 0; }
        .jugador-tag { background: #2c2c2c; color: var(--primary); padding: 8px 15px; border-radius: 15px; border: 1px solid var(--primary); font-weight: bold; }
        .dados-container { display: flex; justify-content: center; gap: 8px; margin: 15px 0; height: 85px; align-items: center; width: 100%; }
        .dado-visual { width: 55px; height: 55px; background: white; border-radius: 10px; display: grid; grid-template: repeat(3, 1fr) / repeat(3, 1fr); padding: 5px; box-sizing: border-box; cursor: pointer; border: 3px solid transparent; flex-shrink: 0; }
        .dot { background: #333; border-radius: 50%; width: 8px; height: 8px; margin: auto; }
        .bloqueado { background: var(--primary) !important; transform: translateY(-10px); }
        .girando { animation: saltar 0.15s infinite alternate; }
        @keyframes saltar { 0% { transform: translateY(0); } 100% { transform: translateY(-10px); } }
        .contenedor-tabla { overflow-x: auto; width: 100%; margin-top: 15px; border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; background: #252525; font-size: 0.9rem; }
        th, td { border: 1px solid #333; padding: 10px 4px; text-align: center; }
        th { background: #333; color: var(--primary); }
        .celda-activa { background: rgba(39, 174, 96, 0.2); cursor: pointer; color: #2ecc71; font-weight: bold; }
        .celda-tachar { color: #e74c3c; font-style: italic; }
        .anotado { color: var(--primary); font-weight: bold; background: rgba(241, 196, 15, 0.05); }
        .fila-total { background: #1a1a1a; font-weight: bold; color: #fff; }
        #cartel-ganador { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--primary); color: #000; padding: 30px; border-radius: 30px; z-index: 1000; text-align: center; border: 4px solid white; width: 80%; }
        button { background: var(--success); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        input { padding: 12px; border-radius: 8px; border: 1px solid #444; background: #252525; color: white; width: 60%; }
    </style>
</head>
<body>

    <div id="seccion-registro" class="setup">
        <h2>üé≤ Nueva Partida</h2>
        <div style="display: flex; gap: 5px; justify-content: center;">
            <input type="text" id="nombre-input" placeholder="Nombre...">
            <button onclick="agregarJugador()">A√±adir</button>
        </div>
        <div id="lista-nombres"></div>
        <button id="btn-iniciar" class="oculto" onclick="iniciarJuego()">¬°EMPEZAR!</button>
    </div>

    <div id="seccion-juego" class="juego oculto">
        <h2 id="turno-de" style="color: var(--primary); margin: 5px 0;">-</h2>
        <div class="dados-container" id="contenedor-dados"></div>
        <button id="btn-lanzar" onclick="lanzar()">LANZAR (3)</button>
        <p id="instruccion">Tira los dados</p>
        <div class="contenedor-tabla">
            <table>
                <thead><tr id="header-jugadores"><th>Categor√≠a</th></tr></thead>
                <tbody id="cuerpo-tabla"></tbody>
                <tfoot><tr id="footer-totales" class="fila-total"><td>TOTAL</td></tr></tfoot>
            </table>
        </div>
        <button onclick="abortarPartida()" style="background: #c0392b; margin-top: 20px; font-size: 0.7rem;">Anular y Reiniciar</button>
    </div>

    <div class="historial">
        <h3>üìú R√©cords Recientes</h3>
        <div id="lista-historial"></div>
        <button onclick="borrarHistorial()" style="background:#c0392b; font-size:0.7rem;">Borrar Historial</button>
    </div>

    <div id="cartel-ganador" class="oculto">
        <h1 style="font-size: 2.5rem;">üèÜ</h1>
        <h2 id="nombre-ganador"></h2>
        <p id="puntos-ganador"></p>
        <button onclick="finalizarYLimpiar()" style="background: black; color: white; width: 100%;">Nueva Partida</button>
    </div>

<script>
    let jugadores = [], indiceTurno = 0, tiros = 3, dadosValores = [0,0,0,0,0], bloqueados = [false, false, false, false, false], celdasOcupadas = 0;
    const categorias = ["1", "2", "3", "4", "5", "6", "Escalera", "Full", "Poker", "Generala", "Doble Gen"];
    const layouts = { 1: [4], 2: [0, 8], 3: [0, 4, 8], 4: [0, 2, 6, 8], 5: [0, 2, 4, 6, 8], 6: [0, 3, 6, 2, 5, 8] };

    window.onload = () => { mostrarHistorial(); recuperarPartida(); };

    function guardarPartida() {
        const estado = { jugadores, indiceTurno, celdasOcupadas, puntos: categorias.map(cat => jugadores.map((_, i) => {
            const celda = document.getElementById(`p-${cat}-${i}`);
            return celda ? { texto: celda.innerText, fixed: celda.getAttribute('data-fixed') } : null;
        }))};
        localStorage.setItem('partida_v3', JSON.stringify(estado));
    }

    function recuperarPartida() {
        const guardado = localStorage.getItem('partida_v3');
        if (!guardado) return;
        const estado = JSON.parse(guardado);
        jugadores = estado.jugadores;
        indiceTurno = estado.indiceTurno;
        celdasOcupadas = estado.celdasOcupadas;
        iniciarJuego(true);
        categorias.forEach((cat, cIdx) => { jugadores.forEach((_, jIdx) => {
            const celda = document.getElementById(`p-${cat}-${jIdx}`);
            const data = estado.puntos[cIdx][jIdx];
            if (data && data.fixed === 'true') {
                celda.innerText = data.texto; celda.className = 'anotado'; celda.setAttribute('data-fixed', 'true');
            }
        });});
        actualizarTurno();
    }

    function abortarPartida() { if(confirm("¬øBorrar partida actual?")) { localStorage.removeItem('partida_v3'); location.reload(); } }
    function agregarJugador() {
        const input = document.getElementById('nombre-input');
        if (input.value.trim()) { jugadores.push({ nombre: input.value.trim(), total: 0 }); renderLista(); input.value = ""; }
    }
    function renderLista() {
        document.getElementById('lista-nombres').innerHTML = jugadores.map(j => `<span class="jugador-tag">${j.nombre}</span>`).join('');
        document.getElementById('btn-iniciar').classList.toggle('oculto', jugadores.length === 0);
    }

    function iniciarJuego(recuperando = false) {
        document.getElementById('seccion-registro').classList.add('oculto');
        document.getElementById('seccion-juego').classList.remove('oculto');
        document.getElementById('header-jugadores').innerHTML = '<th>Categor√≠a</th>';
        document.getElementById('footer-totales').innerHTML = '<td>TOTAL</td>';
        document.getElementById('cuerpo-tabla').innerHTML = '';
        jugadores.forEach((j, idx) => {
            document.getElementById('header-jugadores').innerHTML += `<th>${j.nombre.substring(0,5)}</th>`;
            document.getElementById('footer-totales').innerHTML += `<td id="total-${idx}">${j.total}</td>`;
        });
        categorias.forEach(cat => {
            document.getElementById('cuerpo-tabla').innerHTML += `<tr><td style="font-weight:bold">${cat}</td>` + 
                jugadores.map((_, i) => `<td id="p-${cat}-${i}" class="celda-puntos">-</td>`).join('') + `</tr>`;
        });
        if(!recuperando) { actualizarTurno(); guardarPartida(); }
        else { recalcularTotales(); }
    }

    function lanzar() {
        if (tiros > 0) {
            tiros--;
            document.getElementById('btn-lanzar').innerText = `LANZAR (${tiros})`;
            document.querySelectorAll('.dado-visual').forEach((d, i) => { if(!bloqueados[i]) d.classList.add('girando'); });
            setTimeout(() => {
                document.querySelectorAll('.dado-visual').forEach((d, i) => {
                    if(!bloqueados[i]) dadosValores[i] = Math.floor(Math.random() * 6) + 1;
                    d.classList.remove('girando');
                });
                dibujarDados(); calcularOpciones(tiros === 2);
            }, 600);
        }
    }

    function calcularOpciones(esServida) {
        limpiarOtras();
        const conteo = {1:0, 2:0, 3:0, 4:0, 5:0, 6:0}; 
        dadosValores.forEach(v => { if(v > 0) conteo[v]++; });
        const vals = Object.values(conteo);
        const unicosStr = [...new Set(dadosValores.filter(v => v > 0))].sort((a,b)=>a-b).join('');
        const bono = esServida ? 5 : 0;
        const yaTieneGenerala = (document.getElementById(`p-Generala-${indiceTurno}`).getAttribute('data-fixed') === 'true');

        categorias.forEach(cat => {
            let pts = 0;
            if (!isNaN(cat)) pts = conteo[parseInt(cat)] * parseInt(cat);
            else if (cat === "Escalera" && (unicosStr === "12345" || unicosStr === "23456" || unicosStr === "13456")) pts = 20 + bono;
            else if (cat === "Full" && vals.includes(3) && vals.includes(2)) pts = 30 + bono;
            else if (cat === "Poker" && (vals.includes(4) || vals.includes(5))) pts = 40 + bono;
            else if (cat === "Generala" && vals.includes(5) && !yaTieneGenerala) pts = 50;
            else if (cat === "Doble Gen" && vals.includes(5) && yaTieneGenerala) pts = 100;

            const celda = document.getElementById(`p-${cat}-${indiceTurno}`);
            // CANDADO: Solo si la celda no est√° fija
            if (celda && celda.getAttribute('data-fixed') !== 'true') {
                celda.innerText = pts === 0 ? "X" : pts;
                celda.classList.add('celda-activa');
                if (pts === 0) celda.classList.add('celda-tachar');
                celda.onclick = () => {
                    if (celda.getAttribute('data-fixed') === 'true') return; // Seguridad extra
                    if(confirm(pts === 0 ? `¬øTachar ${cat}?` : `¬øAnotar ${pts} en ${cat}?`)) {
                        celda.innerText = pts; celda.className = 'anotado'; celda.setAttribute('data-fixed', 'true');
                        celda.onclick = null;
                        recalcularTotales(); celdasOcupadas++;
                        guardarPartida();
                        if (celdasOcupadas === jugadores.length * categorias.length) finalizarJuego();
                        else { limpiarOtras(); indiceTurno = (indiceTurno + 1) % jugadores.length; actualizarTurno(); }
                    }
                };
            }
        });
    }

    function recalcularTotales() {
        jugadores.forEach((j, idx) => {
            let suma = 0;
            categorias.forEach(cat => {
                const celda = document.getElementById(`p-${cat}-${idx}`);
                if (celda && celda.getAttribute('data-fixed') === 'true') suma += parseInt(celda.innerText) || 0;
            });
            j.total = suma;
            const elTotal = document.getElementById(`total-${idx}`);
            if (elTotal) elTotal.innerText = suma;
        });
    }

    function finalizarJuego() {
        const podio = [...jugadores].sort((a, b) => b.total - a.total);
        const ganador = podio[0];
        const partida = { fecha: new Date().toLocaleDateString(), winner: ganador.nombre, score: ganador.total };
        let hist = JSON.parse(localStorage.getItem('gen_hist_v3')) || [];
        hist.unshift(partida);
        localStorage.setItem('gen_hist_v3', JSON.stringify(hist.slice(0, 5)));
        localStorage.removeItem('partida_v3');
        confetti({ particleCount: 150, spread: 70 });
        document.getElementById('nombre-ganador').innerText = `¬°${ganador.nombre.toUpperCase()}!`;
        document.getElementById('puntos-ganador').innerText = `${ganador.total} puntos`;
        document.getElementById('cartel-ganador').classList.remove('oculto');
    }

    function finalizarYLimpiar() { localStorage.removeItem('partida_v3'); location.reload(); }
    function mostrarHistorial() {
        const h = JSON.parse(localStorage.getItem('gen_hist_v3')) || [];
        document.getElementById('lista-historial').innerHTML = h.map(p => `<div class="item-historial"><b>${p.winner}</b>: ${p.score} pts (${p.fecha})</div>`).join('') || 'Sin r√©cords.';
    }
    function borrarHistorial() { if(confirm("¬øBorrar?")) { localStorage.removeItem('gen_hist_v3'); location.reload(); } }
    function limpiarOtras() { document.querySelectorAll('.celda-activa').forEach(c => { if(c.getAttribute('data-fixed') !== 'true') { c.innerText = "-"; c.classList.remove('celda-activa', 'celda-tachar'); c.onclick = null; } }); }
    function actualizarTurno() {
        document.getElementById('turno-de').innerText = "Turno de: " + jugadores[indiceTurno].nombre;
        tiros = 3; bloqueados = [false, false, false, false, false]; dadosValores = [0,0,0,0,0];
        document.getElementById('btn-lanzar').innerText = `LANZAR (3)`;
        dibujarDados();
    }
    function toggleDado(i) { if (tiros < 3 && tiros > 0 && dadosValores[0] !== 0) { bloqueados[i] = !bloqueados[i]; dibujarDados(); } }
    function dibujarDados() {
        const contenedor = document.getElementById('contenedor-dados');
        contenedor.innerHTML = '';
        for(let i=0; i<5; i++) {
            const div = document.createElement('div');
            div.className = `dado-visual ${bloqueados[i] ? 'bloqueado' : ''}`;
            div.onclick = () => toggleDado(i);
            if (dadosValores[i] > 0) {
                for(let j=0; j<9; j++) {
                    const punto = document.createElement('div');
                    if (layouts[dadosValores[i]].includes(j)) punto.className = 'dot';
                    div.appendChild(punto);
                }
            }
            contenedor.appendChild(div);
        }
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3655/3655610.png?v=4">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3655/3655610.png?v=4">
    <meta property="og:image" content="https://cdn-icons-png.flaticon.com/512/3655/3655610.png?v=4">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Generala Amiga - Pro Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --primary: #f1c40f; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
        .setup, .juego, .historial { background: var(--card); padding: 15px; border-radius: 20px; width: 95%; max-width: 800px; text-align: center; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 15px; box-sizing: border-box; }
        .oculto { display: none; }
        #lista-nombres { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 20px 0; }
        .jugador-tag { background: #2c2c2c; color: var(--primary); padding: 8px 15px; border-radius: 15px; border: 1px solid var(--primary); font-weight: bold; }
        .dados-container { display: flex; justify-content: center; gap: 8px; margin: 10px 0; height: 80px; align-items: center; width: 100%; }
        .dado-visual { width: 50px; height: 50px; background: white; border-radius: 10px; display: grid; grid-template: repeat(3, 1fr) / repeat(3, 1fr); padding: 5px; box-sizing: border-box; cursor: pointer; border: 3px solid transparent; flex-shrink: 0; }
        .dot { background: #333; border-radius: 50%; width: 7px; height: 7px; margin: auto; }
        .bloqueado { background: var(--primary) !important; transform: translateY(-10px); }
        .girando { animation: saltar 0.15s infinite alternate; }
        @keyframes saltar { 0% { transform: translateY(0); } 100% { transform: translateY(-10px); } }
        .contenedor-tabla { overflow-x: auto; width: 100%; margin-top: 15px; border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; background: #252525; font-size: 0.85rem; }
        th, td { border: 1px solid #333; padding: 8px 3px; text-align: center; min-width: 50px; }
        th { background: #333; color: var(--primary); position: relative; }
        .btn-eliminar-jug { color: var(--danger); font-size: 0.7rem; display: block; cursor: pointer; margin-top: 2px; }
        .celda-activa { background: rgba(39, 174, 96, 0.2); cursor: pointer; color: #2ecc71; font-weight: bold; }
        .celda-tachar { color: var(--danger); font-style: italic; }
        .anotado { color: var(--primary); font-weight: bold; }
        .fila-total { background: #1a1a1a; font-weight: bold; color: #fff; }
        button { background: var(--success); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-undo { background: #555; font-size: 0.8rem; padding: 8px 15px; margin-top: 10px; }
        input { padding: 12px; border-radius: 8px; border: 1px solid #444; background: #252525; color: white; width: 60%; }
    </style>
</head>
<body>

    <div id="seccion-registro" class="setup">
        <h2>ðŸŽ² Nueva Partida</h2>
        <div style="display: flex; gap: 5px; justify-content: center;">
            <input type="text" id="nombre-input" placeholder="Nombre...">
            <button onclick="agregarJugador()">AÃ±adir</button>
        </div>
        <div id="lista-nombres"></div>
        <button id="btn-iniciar" class="oculto" onclick="iniciarJuego()">Â¡EMPEZAR!</button>
    </div>

    <div id="seccion-juego" class="juego oculto">
        <h2 id="turno-de" style="color: var(--primary); margin: 5px 0;">-</h2>
        <div class="dados-container" id="contenedor-dados"></div>
        <div style="display:flex; justify-content:center; gap:10px;">
            <button id="btn-lanzar" onclick="lanzar()">LANZAR (3)</button>
            <button id="btn-undo" class="btn-undo oculto" onclick="deshacerUltimaJugada()">â†© Deshacer</button>
        </div>
        <p id="instruccion">Tira los dados</p>
        <div class="contenedor-tabla">
            <table>
                <thead><tr id="header-jugadores"><th>CategorÃ­a</th></tr></thead>
                <tbody id="cuerpo-tabla"></tbody>
                <tfoot><tr id="footer-totales" class="fila-total"><td>TOTAL</td></tr></tfoot>
            </table>
        </div>
        <button onclick="abortarPartida()" style="background: var(--danger); margin-top: 20px; font-size: 0.7rem; padding: 5px 10px;">Anular Partida</button>
    </div>

    <div class="historial">
        <h3>ðŸ“œ RÃ©cords Recientes</h3>
        <div id="lista-historial"></div>
        <button onclick="borrarHistorial()" style="background:var(--danger); font-size:0.7rem; margin-top:10px;">Borrar Historial</button>
    </div>

<script>
    let jugadores = [], indiceTurno = 0, tiros = 3, dadosValores = [0,0,0,0,0], bloqueados = [false, false, false, false, false], celdasOcupadas = 0;
    let ultimaJugada = null; // Para la funciÃ³n deshacer
    const categorias = ["1", "2", "3", "4", "5", "6", "Escalera", "Full", "Poker", "Generala", "Doble Gen"];
    const layouts = { 1: [4], 2: [0, 8], 3: [0, 4, 8], 4: [0, 2, 6, 8], 5: [0, 2, 4, 6, 8], 6: [0, 3, 6, 2, 5, 8] };

    window.onload = () => { mostrarHistorial(); recuperarPartida(); };

    function guardarPartida() {
        const estado = { jugadores, indiceTurno, celdasOcupadas, ultimaJugada, puntos: categorias.map(cat => jugadores.map((_, i) => {
            const celda = document.getElementById(`p-${cat}-${i}`);
            return celda ? { texto: celda.innerText, fixed: celda.getAttribute('data-fixed') } : null;
        }))};
        localStorage.setItem('partida_v4', JSON.stringify(estado));
    }

    function recuperarPartida() {
        const guardado = localStorage.getItem('partida_v4');
        if (!guardado) return;
        const estado = JSON.parse(guardado);
        jugadores = estado.jugadores;
        indiceTurno = estado.indiceTurno;
        celdasOcupadas = estado.celdasOcupadas;
        ultimaJugada = estado.ultimaJugada;
        iniciarJuego(true);
        categorias.forEach((cat, cIdx) => { jugadores.forEach((_, jIdx) => {
            const celda = document.getElementById(`p-${cat}-${jIdx}`);
            if (celda && estado.puntos[cIdx][jIdx]?.fixed === 'true') {
                celda.innerText = estado.puntos[cIdx][jIdx].texto;
                celda.className = 'anotado';
                celda.setAttribute('data-fixed', 'true');
            }
        });});
        actualizarTurno();
    }

    function agregarJugador() {
        const input = document.getElementById('nombre-input');
        if (input.value.trim()) { jugadores.push({ nombre: input.value.trim(), total: 0 }); renderLista(); input.value = ""; }
    }

    function renderLista() {
        document.getElementById('lista-nombres').innerHTML = jugadores.map(j => `<span class="jugador-tag">${j.nombre}</span>`).join('');
        document.getElementById('btn-iniciar').classList.toggle('oculto', jugadores.length === 0);
    }

    function iniciarJuego(recuperando = false) {
        document.getElementById('seccion-registro').classList.add('oculto');
        document.getElementById('seccion-juego').classList.remove('oculto');
        renderTabla();
        if(!recuperando) { actualizarTurno(); guardarPartida(); }
        else { recalcularTotales(); }
    }

    function renderTabla() {
        let header = '<th>Cat.</th>';
        let footer = '<td>TOTAL</td>';
        jugadores.forEach((j, idx) => {
            header += `<th>${j.nombre.substring(0,5)}<span class="btn-eliminar-jug" onclick="eliminarJugador(${idx})">âœ– Borrar</span></th>`;
            footer += `<td id="total-${idx}">0</td>`;
        });
        document.getElementById('header-jugadores').innerHTML = header;
        document.getElementById('footer-totales').innerHTML = footer;

        let cuerpo = '';
        categorias.forEach(cat => {
            cuerpo += `<tr><td style="font-weight:bold">${cat}</td>` + 
                jugadores.map((_, i) => `<td id="p-${cat}-${i}" class="celda-puntos">-</td>`).join('') + `</tr>`;
        });
        document.getElementById('cuerpo-tabla').innerHTML = cuerpo;
    }

    function eliminarJugador(idx) {
        if(confirm(`Â¿Eliminar a ${jugadores[idx].nombre} de la partida?`)) {
            jugadores.splice(idx, 1);
            if (jugadores.length === 0) { abortarPartida(); return; }
            if (indiceTurno >= jugadores.length) indiceTurno = 0;
            renderTabla();
            recuperarPuntosDeCeldas(); // Re-vincula los puntos que ya estaban
            recalcularTotales();
            actualizarTurno();
            guardarPartida();
        }
    }

    function recuperarPuntosDeCeldas() {
        // Esta funciÃ³n ayuda a que si borrÃ¡s a alguien, los puntos de los demÃ¡s no se muevan de lugar
        const guardado = JSON.parse(localStorage.getItem('partida_v4'));
        if (!guardado) return;
        // (LÃ³gica de re-poblado simplificada por renderTabla)
    }

    function lanzar() {
        if (tiros > 0) {
            tiros--;
            document.getElementById('btn-lanzar').innerText = `LANZAR (${tiros})`;
            document.querySelectorAll('.dado-visual').forEach((d, i) => { if(!bloqueados[i]) d.classList.add('girando'); });
            setTimeout(() => {
                document.querySelectorAll('.dado-visual').forEach((d, i) => {
                    if(!bloqueados[i]) dadosValores[i] = Math.floor(Math.random() * 6) + 1;
                    d.classList.remove('girando');
                });
                dibujarDados(); calcularOpciones(tiros === 2);
            }, 600);
        }
    }

    function calcularOpciones(esServida) {
        limpiarOtras();
        const conteo = {1:0, 2:0, 3:0, 4:0, 5:0, 6:0}; 
        dadosValores.forEach(v => { if(v > 0) conteo[v]++; });
        const vals = Object.values(conteo);
        const unicosStr = [...new Set(dadosValores.filter(v => v > 0))].sort((a,b)=>a-b).join('');
        const bono = esServida ? 5 : 0;
        const yaTieneGenerala = (document.getElementById(`p-Generala-${indiceTurno}`).getAttribute('data-fixed') === 'true');

        categorias.forEach(cat => {
            let pts = 0;
            if (!isNaN(cat)) pts = conteo[parseInt(cat)] * parseInt(cat);
            else if (cat === "Escalera" && (unicosStr === "12345" || unicosStr === "23456" || unicosStr === "13456")) pts = 20 + bono;
            else if (cat === "Full" && vals.includes(3) && vals.includes(2)) pts = 30 + bono;
            else if (cat === "Poker" && (vals.includes(4) || vals.includes(5))) pts = 40 + bono;
            else if (cat === "Generala" && vals.includes(5) && !yaTieneGenerala) pts = 50;
            else if (cat === "Doble Gen" && vals.includes(5) && yaTieneGenerala) pts = 100;

            const celda = document.getElementById(`p-${cat}-${indiceTurno}`);
            if (celda && celda.getAttribute('data-fixed') !== 'true') {
                celda.innerText = pts === 0 ? "X" : pts;
                celda.classList.add('celda-activa');
                if (pts === 0) celda.classList.add('celda-tachar');
                celda.onclick = () => anotar(cat, pts, celda);
            }
        });
    }

    function anotar(cat, pts, celda) {
        if(confirm(`Â¿Confirmar ${pts === 0 ? 'Tachar' : pts} en ${cat}?`)) {
            ultimaJugada = { cat, pts, indiceJugador: indiceTurno }; // Guardamos para deshacer
            celda.innerText = pts; celda.className = 'anotado'; celda.setAttribute('data-fixed', 'true');
            celda.onclick = null;
            recalcularTotales(); celdasOcupadas++;
            indiceTurno = (indiceTurno + 1) % jugadores.length;
            actualizarTurno();
            guardarPartida();
        }
    }

    function deshacerUltimaJugada() {
        if (!ultimaJugada) return;
        if (confirm("Â¿Deshacer la Ãºltima anotaciÃ³n?")) {
            indiceTurno = ultimaJugada.indiceJugador; // Vuelve el turno al que se equivocÃ³
            const celda = document.getElementById(`p-${ultimaJugada.cat}-${indiceTurno}`);
            celda.innerText = "-";
            celda.className = "celda-puntos";
            celda.removeAttribute('data-fixed');
            celdasOcupadas--;
            ultimaJugada = null; // Solo se puede deshacer una vez
            recalcularTotales();
            actualizarTurno();
            guardarPartida();
        }
    }

    function recalcularTotales() {
        jugadores.forEach((j, idx) => {
            let suma = 0;
            categorias.forEach(cat => {
                const celda = document.getElementById(`p-${cat}-${idx}`);
                if (celda && celda.getAttribute('data-fixed') === 'true') suma += parseInt(celda.innerText) || 0;
            });
            j.total = suma;
            const elTotal = document.getElementById(`total-${idx}`);
            if (elTotal) elTotal.innerText = suma;
        });
    }

    function actualizarTurno() {
        document.getElementById('turno-de').innerText = "Turno de: " + jugadores[indiceTurno].nombre;
        tiros = 3; bloqueados = [false, false, false, false, false]; dadosValores = [0,0,0,0,0];
        document.getElementById('btn-lanzar').innerText = `LANZAR (3)`;
        document.getElementById('btn-undo').classList.toggle('oculto', !ultimaJugada);
        dibujarDados();
    }

    function dibujarDados() {
        const contenedor = document.getElementById('contenedor-dados');
        contenedor.innerHTML = '';
        for(let i=0; i<5; i++) {
            const div = document.createElement('div');
            div.className = `dado-visual ${bloqueados[i] ? 'bloqueado' : ''}`;
            div.onclick = () => { if (tiros < 3 && tiros > 0 && dadosValores[0] !== 0) { bloqueados[i] = !bloqueados[i]; dibujarDados(); } };
            if (dadosValores[i] > 0) {
                for(let j=0; j<9; j++) {
                    const punto = document.createElement('div');
                    if (layouts[dadosValores[i]].includes(j)) punto.className = 'dot';
                    div.appendChild(punto);
                }
            }
            contenedor.appendChild(div);
        }
    }

    function abortarPartida() { if(confirm("Â¿Anular partida actual?")) { localStorage.removeItem('partida_v4'); location.reload(); } }
    function limpiarOtras() { document.querySelectorAll('.celda-activa').forEach(c => { if(c.getAttribute('data-fixed') !== 'true') { c.innerText = "-"; c.classList.remove('celda-activa', 'celda-tachar'); c.onclick = null; } }); }
    function mostrarHistorial() {
        const h = JSON.parse(localStorage.getItem('gen_hist_v3')) || [];
        document.getElementById('lista-historial').innerHTML = h.map(p => `<div style="background:#252525; padding:5px; margin:5px; border-radius:5px; font-size:0.8rem;"><b>${p.winner}</b>: ${p.score} pts</div>`).join('') || 'Sin rÃ©cords.';
    }
    function borrarHistorial() { if(confirm("Â¿Borrar?")) { localStorage.removeItem('gen_hist_v3'); location.reload(); } }
</script>
</body>
</html>
